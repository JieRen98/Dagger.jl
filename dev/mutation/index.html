<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mutation and Shards · Dagger.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://JuliaParallel.github.io/Dagger.jl/mutation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Dagger.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../dtable/">Distributed Table</a></li><li><a class="tocitem" href="../processors/">Processors</a></li><li><a class="tocitem" href="../scopes/">Scopes</a></li><li class="is-active"><a class="tocitem" href>Mutation and Shards</a><ul class="internal"><li><a class="tocitem" href="#Sharding"><span>Sharding</span></a></li></ul></li><li><a class="tocitem" href="../dynamic/">Dynamic Scheduler Control</a></li><li><a class="tocitem" href="../logging/">Logging and Graphing</a></li><li><a class="tocitem" href="../scheduler-visualization/">Scheduler Visualization</a></li><li><a class="tocitem" href="../benchmarking/">Benchmarking</a></li><li><a class="tocitem" href="../checkpointing/">Checkpointing</a></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../api/types/">Types</a></li><li><a class="tocitem" href="../api/functions/">Functions and Macros</a></li></ul></li><li><a class="tocitem" href="../scheduler-internals/">Scheduler Internals</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Mutation and Shards</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mutation and Shards</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaParallel/Dagger.jl/blob/master/docs/src/mutation.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Mutation-Support"><a class="docs-heading-anchor" href="#Mutation-Support">Mutation Support</a><a id="Mutation-Support-1"></a><a class="docs-heading-anchor-permalink" href="#Mutation-Support" title="Permalink"></a></h1><p>Normally, Dagger tasks should be functional and &quot;pure&quot;: never mutating their inputs, always producing identical outputs for a given set of inputs, and never producing side effects which might affect future program behavior. However, for certain codes, this restriction ends up costing the user performance and engineering time to work around.</p><p>Thankfully, Dagger provides the <code>Dagger.@mutable</code> macro for just this purpose. <code>@mutable</code> allows data to be marked such that it will never be copied or serialized by the scheduler (unless copied by the user). When used as an argument to a task, the task will be forced to execute on the same worker that <code>@mutable</code> was called on. For example:</p><pre><code class="language-julia hljs">x = remotecall_fetch(2) do
    Dagger.@mutable Threads.Atomic{Int}(0)
end
x::Dagger.Chunk # The result is always a `Chunk`

# x is now considered mutable, and may only be accessed on worker 2:
fetch(Dagger.@spawn Threads.atomic_add!(x, 3)) # Always executed on worker 2
fetch(Dagger.@spawn single=1 Threads.atomic_add!(x, 3)) # SchedulingException</code></pre><p><code>@mutable</code>, when called as above, gain a scope of <code>ProcessorScope(myid())</code>, which means that any processor on that worker is allowed to execute tasks that use the object (subject to the usual scheduling rules).</p><p><code>@mutable</code> also has two other forms, allowing the processor and scope to be manually supplied:</p><pre><code class="language-julia hljs">proc1 = Dagger.ThreadProc(myid(), 3)
proc2 = Dagger.ThreadProc(myid(), 4)
scope = Dagger.UnionScope(ExactScope.([proc1, proc2]))
x = @mutable OSProc() scope rand(100)
# x is now scoped to threads 3 and 4 on worker `myid()`</code></pre><h2 id="Sharding"><a class="docs-heading-anchor" href="#Sharding">Sharding</a><a id="Sharding-1"></a><a class="docs-heading-anchor-permalink" href="#Sharding" title="Permalink"></a></h2><p><code>@mutable</code> is convenient for creating a single mutable object, but often one wants to have multiple mutable objects, with each object being scoped to their own worker or thread in the cluster, to be used as local counters, partial reduction containers, data caches, etc.</p><p>The <code>Shard</code> object (constructed with <code>Dagger.@shard</code>/<code>Dagger.shard</code>) is a mechanism by which such a setup can be created with one invocation.  By default, each worker will have their own local object which will be used when a task that uses the shard as an argument is scheduled on that worker. Other shard pieces that aren&#39;t scoped to the processor being executed on will not be serialized or copied, keeping communication costs constant even with a very large shard.</p><p>This mechanism makes it easy to construct a distributed set of mutable objects which are treated as &quot;mirrored shards&quot; by the scheduler, but require no further user input to access. For example, creating and using a local counter for each worker is trivial:</p><pre><code class="language-julia hljs"># Create a local atomic counter on each worker that Dagger knows about:
cs = Dagger.@shard Threads.Atomic{Int}(0)

# Let&#39;s add `1` to the local counter, not caring about which worker we&#39;re on:
wait.([Dagger.@spawn Threads.atomic_add!(cs, 1) for i in 1:1000])

# And let&#39;s fetch the total sum of all counters:
@assert sum(fetch.(map(ctr-&gt;ctr[], cs))) == 1000</code></pre><p>Note that <code>map</code>, when used on a shard, will execute the provided function once per shard &quot;piece&quot;, and each result is considered immutable. <code>map</code> is an easy way to make a copy of each piece of the shard, to be later reduced, scanned, etc.</p><p>Further details about what arguments can be passed to <code>@shard</code>/<code>shard</code> can be found in <a href="../api/functions/#Shard-Functions">Shard Functions</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../scopes/">« Scopes</a><a class="docs-footer-nextpage" href="../dynamic/">Dynamic Scheduler Control »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Sunday 12 December 2021 00:13">Sunday 12 December 2021</span>. Using Julia version 1.6.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
